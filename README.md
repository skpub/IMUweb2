# IMUweb2

インモラル大学のウェブシステムIMUweb2の仕様書です。

## 目的

* 私のマイクラサーバであるインモラル大学において、これの宣伝・連絡周知を行うこと
* ユーザ管理、ワールド管理、バックアップ管理を行う機能、及びwebインタフェースを提供すること

## 定義

### 学長・学生

インモラル大学のウェブシステムIMUweb2(以下: システム)の利用者(以下: 気分次第でクライアントとかClientとか学生とか言う)には管理者と一般利用者の区別がある。

### 学生

システムの一般利用者を、学生と呼ぶ。

### 学長

システムの管理者を、学長と呼ぶ。学長とは私、佐藤海音のことである。

### プロシージャ

プロシージャとは、システムの各コンポーネントが他の特定のコンポーネントから受け付けている各種の手続きのことである。

### システム構成

|コンポーネント|説明|責任|
|---|---|---|
|IMUwebapp|Next.jsで作られたフルスタックアプリケーション|認証情報の検証・管理者による認可とwebインタフェースの提供|
|Minecraft Server(以下、マイクラサーバ)|PurpurやPaperなどで動いているマイクラサーバ|マイクラサーバとしての可用性、及び認証|
|PostgreSQL|ユーザの権限を管理するデータベース|ユーザの権限情報を保持すること|
|systemd services|systemdで定義されたサービスたち|他のコンポーネントのプロセスとデータを、破綻を来さず管理すること|
|クライアント|学生と学長|学長の許容できる振る舞いに努めること、さもなくば可及的速やかに鬼籍に入ること|

## システム構成図

![システム構成図](/spec_assets/システム構成図.png "システム構成図")

## 認証・認可フロー

初回のアカウント発行時の動作を説明する。

1. プレイヤーがマイクラサーバにログイン(補足: この時点でMojang公式サーバの認証が通っているのでこの時点で信頼)
1. マイクラサーバはクライアントにワンタイムコードを発行する
1. プレイヤーは提示されたリンクを踏んでブラウザからIMUwebappにアクセスし、ワンタイムコードを送信
1. IMUwebappはマイクラサーバにワンタイムコードを送信(gRPC)
1. マイクラサーバはワンタイムコードが検証できた場合IDトークンをIMUwebappに返す(gRPC)
1. IMUwebappは認証ミドルウェアでIDトークンを検証
1. IMUwebappは認可ミドルウェアで最低権限を付与したアクセストークンを学生に発行(Set-Cookie)

初回のアカウント発行が適切に処理された場合、クライアントはブラウザ上のCookieにアクセストークンを保持した状態になる。

これ以降のクライアントのIMUwebappの認証を必要とする`/auth`エンドポイントへのアクセスにおいて、
認証・認可は`/auth/layout.tsx`(Server Component)により透過的に処理され、学長が与えた権限に従って利用者の呼び出せるプロシージャが適切に制限される。
なお、ここでの認可は学長による認可のことであって、システムのすべてのリソースのオーナーは学長であることに注意されたい。

## IMUwebappの詳細

### サーバコンポーネント: バックアップスケジューラ

|権限|内容|
|---|---|
|学長|バックアップには自動モード(30分ごと)と、手動モードがある。これの切り替え命令をsystemdに発行する。|

### サーバコンポーネント: マイクラサーバ停止・開始

|権限|内容|
|---|---|
|学長|マイクラサーバの停止・開始命令をsystemdに発行する。|

### サーバコンポーネント: バックアップリストア

|権限|内容|
|---|---|
|学長|バックアップのリストア命令をsystemdに発行する。|

### サーバコンポーネント: 権限管理

|権限|内容|
|---|---|
|学長|権限の閲覧・改変を行う。|

|権限|内容|
|---|---|
|学生|権限の閲覧を行う。|

## PostgreSQLの詳細

`docker compose up -d` で動かす。

動作に次の環境変数を必要とする (/.env)。

|環境変数|内容|
|---|---|
|DB_PORT|DBを動かすポート|
|DB_USER|DBのユーザ名|
|DB_PASSWORD|DBのパスワード|
|DB_NAME|DB名|
|ADMIN_UUID|管理者のマイクラのUUID|
|ADMIN_USERNAME|管理者のマイクラのユーザ名|

具体例は次の通り

```env
DB_PORT=5432
DB_USER=kaito
DB_PASSWORD=kaito
DB_NAME=imuweb_db
ADMIN_UUID=c5567453-d31a-4e0a-96d1-81b97422b561
ADMIN_USERNAME=sato_kaito
```

## Minecraft Serverの詳細

### プラグイン: バックアップ管理

IMUwebappのサーバコンポーネント: バックアップスケジューラによって呼ばれ、指示された通りのスケジュールでsystemdにバックアップ命令を発行するgRPCのプロシージャ。

### プラグイン: 権限管理

IMUwebappのサーバコンポーネント: 権限管理によって呼ばれ、指示された通りの権限を各プレイヤーに付与する(コマンドの実行権限など)gRPCのプロシージャ。

### プラグイン: ID発行(IDTokenProvider)

このプラグインは動作に4つの環境変数を必要とする。次の通り。

|環境変数|内容|
|---|---|
|ID_TOKEN_PROVIDER_SECRET|ID Token生成秘密鍵|
|IMU_ID_ISSUER|認証サーバ名(この際IMUserver)|
|IMU_WEBAPP|リソースサーバ名(この際IMUwebapp)|

プレイヤーがマイクラサーバに初回ログインした時点でMojang公式サーバの認証が通っていることを根拠に信頼し、
期限の短いワンタイムコードを発行する。
形式としては、`/msg`コマンドにより当該プレイヤーのみにIMUwebappへのリンクとワンタイムコードを送りつけるというもの。

## systemdの詳細

次のサービスを提供する。

|サービス名称|内容|
|---|---|
|minecraft.service|マイクラサーバを(停止|開始)する|
|minecraft_backup.service (oneshot)|マイクラサーバのバックアップを実行する|
|minecraft_backup.timer |マイクラサーバのバックアップをタイマー実行する(30minおき)|

内部的にはスクリプトでマイクラサーバのtmuxセッションを管理しつつ適当なコマンドを呼ぶ構成になっている
(/systemd/service.sh)


次の環境変数を必要とする(/etc/default/IMUbackup.env)

|環境変数|内容|
|---|---|
|USER|UNIXユーザ名|
|GROUP|UNIXグループ名|
|MC_HOME|マイクラのpaper.jarを動かすPATH|
|IMU_REPO|このリポジトリをcloneしたPATH|
|ZFS_TANK|ZFSのタンク名|
|GENERATION|バックアップの世代数|

### 環境変数の例

```env
USER=kaito
GROUP=kaito
MC_HOME=/home/kaito/MCServer
IMU_REPO=/home/kaito/IMUweb2
ZFS_TANK=mcserver
GENERATION=48
```

## PostgreSQLの詳細

ユーザの権限情報を管理する。
